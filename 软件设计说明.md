# 软件设计说明

> 本文档面向研发和研究人员，详细阐述本项目的设计理念、架构、数据与部署方案，强调可扩展性、可复现性与科研可视化能力。系统聚焦网络流量学习的多任务场景：半监督分类、特征稳定性挖掘、增量学习评估，以及可解释性/对抗分析，并通过 Streamlit 提供交互界面。

---

## 一、软件/系统/工具/数据集概述

### 软件核心用途
- **统一实验工作台**：集成半监督学习、特征稳定性、增量学习与对抗可解释性，避免分散脚本，支持一键运行与结果浏览。
- **可视化与交互**：通过 Streamlit 实时展示曲线、混淆矩阵、t-SNE、特征柱状图、热力图，以及对抗/防御效果对比。
- **复现与对比**: 支持加载既有结果，或在界面触发重新训练/评估，方便横向比较模型与设置。

### 使用场景
- **学术研究**：快速验证半监督比例敏感性、特征稳定性与对抗鲁棒性，生成图表用于论文/报告。
- **工程实验**：本地有数据和 checkpoint 的情况下，直接评估增量模型或对抗检测逻辑，观察实际性能。
- **教学/演示**：以交互方式展示可解释性（梯度归因）、对抗攻击（FGSM），以及简单的检测启发。

### 数据集
- **USTC-TFC**：Hex 字节 CSV，按类别分文件（`ustc_all/0.csv ...`），用于半监督与增量学习。
- **CIC-IDS2017**：数值 CSV（`ids2017/data.csv`），带列名，用于特征稳定性与对抗/解释实验。
- **模型/检查点**：如 `ids2017/11ids2017.pt`（全连接分类器）、`incremental/ustc_model`（增量学习模型）。

---

## 二、架构设计

### 整体架构
- **训练/分析脚本层**  
  - `semi_supervised_experiment.py`：伪标签半监督训练，生成学习曲线、混淆矩阵、t-SNE、summary CSV。  
  - `ids2017_feature_stability.py`：随机森林多种子特征重要性，输出特征稳定性 CSV/图表。  
  - `ids2017_explain_adv.py`：梯度归因、FGSM 对抗、简易防御检测（置信度下降 + L∞ 阈值）。  
  - `incremental_adapter.py`：封装增量模型加载与评估（调用 `incremental/models_adapted.py` 与 checkpoint）。  
  - `run_generate_results.sh`：可选一键生成半监督与特征稳定性结果。

- **交互层（UI）**  
  - `interactive_app.py`：Streamlit 四页签  
    1) Semi-Supervised（USTC）  
    2) Stable Features（CIC-IDS2017）  
    3) Incremental (USTC)  
    4) Explainability & Adversarial（CIC-IDS2017）  
    支持“加载已有结果”或“一键运行”，带进度条/折叠日志。

- **结果与资源层**  
  - 结果目录：`outputs/`（半监督）、`ids2017_feature_outputs/`（稳定性）、`ids2017_explain_outputs/`（解释/对抗）。  
  - 模型目录：`incremental/`、`ids2017/` 下的 checkpoint。  
  - 数据目录：`ustc_all/`、`ids2017/data.csv`。

### 主要功能模块
1. **半监督学习（USTC）**  
   - 数据加载：Hex→byte→[0,1] 归一化；按类划分 Labeled/Unlabeled/Test。  
   - 训练：MLP + 伪标签（阈值 0.9，权重 λ configurable），支持多比例 sweep。  
   - 可视化：学习曲线、混淆矩阵、t-SNE；summary CSV 输出随比例的精度。  
   - UI：手动加载已有结果或一键运行，进度按 epoch 推进。

2. **特征稳定性（CIC-IDS2017）**  
   - 数据预处理：MinMax 归一化，缺失用中位数；按多随机种子训练 RandomForest。  
   - 统计：mean/std/mean_rank、Top-K 频次、特征对共现（pair 计数）、rank 相关。  
   - 可视化：柱状图（倾斜标签防重叠）、热力图。  
   - UI：加载/运行两种模式，展示表格、图像。

3. **增量学习（USTC）**  
   - 复用增量模型（adapt_net），读取 checkpoint，对全量/采样数据评估。  
   - UI：输入数据目录、模型路径、每类样本上限，点击评估。

4. **可解释性与对抗（CIC-IDS2017）**  
   - 梯度归因：对单样本计算 |grad * input|，展示 Top-K 特征。  
   - 对抗：FGSM（可调 epsilon），显示攻击前后预测、归因对比。  
   - 防御检测：批量 FGSM，依据置信度下降阈值 + L∞ 阈值做启发式检测，输出攻击成功率与检测率。  
   - UI：可视化表格与柱状图，明细记录可查看。

### 模块间交互逻辑
- 训练/分析脚本独立产出结果目录；UI 读取现有结果或通过子进程触发脚本重新生成。  
- 参数（路径、阈值、比例、epsilon）由 Streamlit 控件传入，相应模块在内存或子进程中执行。  
- 半监督与增量共用 USTC 数据；稳定性与对抗共用 IDS2017 数据；结果相互独立但可在 UI 并列对比。  
- 防御评估与对抗生成在 UI 运行时即时计算，不写入结果目录（除可解释性柱状图保存）。

---

## 三、数据设计

### 核心数据实体
- **流量特征矩阵**：USTC (784 维 Hex 字节)；CIC-IDS2017 (78 维数值特征)。  
- **标签**：整数编码；CIC-IDS2017 保留原始文本标签用于显示。  
- **训练指标**：半监督的 `metrics.json`（loss/acc 曲线）、`summary_results.csv`（比例→精度）。  
- **可视化产物**：PNG（学习曲线、混淆矩阵、t-SNE、特征柱状图、热力图、归因对比）。  
- **稳定性统计**：`feature_stability.csv`（mean/std/mean_rank/topK 频次）、`stable_pairs.csv`（共现计数）。  
- **对抗/防御记录**：UI 运行时生成的 DataFrame（预测、置信度下降、L∞ 等），不强制落盘。

### 关键数据存储方式与说明
- **原始数据**：CSV 存储；USTC 每类独立文件；CIC-IDS2017 单文件含列名。  
- **指标/日志**：JSON、CSV；UI 以 Pandas 读取显示。  
- **模型**：PyTorch checkpoint（`.pt`），支持 DataParallel 前缀清理。  
- **可视化**：Pillow/Matplotlib 生成 PNG；标签倾斜防重叠（默认 30°）。  
- **中间参数**：Streamlit session_state 持久化加载状态（数据、模型、特征名等）。

---

## 四、部署说明

### 运行环境要求
- Python 3.9+；建议 Conda 环境。  
- 核心依赖：`torch`、`pandas`、`numpy`、`scikit-learn`、`streamlit`、`Pillow`、`matplotlib`。  
- GPU 可选：半监督/对抗可用 GPU 加速，但默认 CPU 兼容。

### 部署步骤
1. **安装依赖**  
   ```bash
   pip install -r requirements.txt
   # 或手动：pip install torch pandas numpy scikit-learn streamlit pillow matplotlib
   ```
2. **准备数据与模型**  
   - USTC：将 Hex CSV 置于 `ustc_all/`。  
   - CIC-IDS2017：放置 `ids2017/data.csv`。  
   - 模型：如 `ids2017/11ids2017.pt`、`incremental/ustc_model`。
3. **生成结果（可选）**  
   - 全量生成：`bash run_generate_results.sh`（半监督 + 特征稳定性）。  
   - 或在 Streamlit 中点击“一键运行”按钮。
4. **启动界面**  
   ```bash
   streamlit run interactive_app.py
   ```
   - 在各页签点击“加载已有结果”或“一键运行”。  
   - 半监督页会显示比例-精度折线；稳定性页显示特征表与图；增量页评估模型；解释/对抗页生成归因/对抗、防御检测。
5. **单独脚本执行（可选）**  
   - 半监督：`python semi_supervised_experiment.py --labeled-ratios 0.01,0.02,...`  
   - 稳定性：`python ids2017_feature_stability.py --seeds 0,1,2`  
   - 对抗/解释：接口在 `ids2017_explain_adv.py`，可嵌入自定义流程。  
   - 增量评估：`python incremental_adapter.py --model-path incremental/ustc_model --data-dir ustc_all`

### 设计考量（高级要点）
- **可复现性**：脚本设置随机种子，模型加载支持前缀清理；结果目录结构固定，UI 直接读取。  
- **可扩展性**：Streamlit 页签解耦，易新增任务；各脚本函数化，便于在 Notebook 或服务中调用。  
- **资源友好**：默认限制线程、采样上限；UI 提供加载/运行开关，避免启动即重算。  
- **安全/鲁棒性**：文件存在性检查、缺失值填充、数值裁剪（归一化、epsilon clamp）。  
- **可解释与防御**：梯度归因 + 简易置信度/范数检测，提供直观的对抗效果与检测率基线，便于后续替换更强防御。

---

## 附录：核心文件清单
- 交互：`interactive_app.py`  
- 半监督：`semi_supervised_experiment.py`  
- 稳定性：`ids2017_feature_stability.py`  
- 对抗/解释：`ids2017_explain_adv.py`  
- 增量适配：`incremental_adapter.py`  
- 一键生成：`run_generate_results.sh`  
- 模型定义：`ids2017/model.py`、`incremental/models_adapted.py`  
- 结果目录：`outputs/`、`ids2017_feature_outputs/`、`ids2017_explain_outputs/`（需运行后生成）
